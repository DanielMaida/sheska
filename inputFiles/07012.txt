Variational autoencoders for tissue heterogeneity exploration
from (almost) no preprocessed mass spectrometry imaging data.
Paolo Inglese, James L. Alexander, Anna Mroz, Zoltan Takats, Robert Glen
August 25, 2017
Abstract
The paper presents the application of Variational Autoencoders (VAE) for data dimensionality
reduction and explorative analysis of mass spectrometry imaging data (MSI). The results confirm
that VAEs are capable of detecting the patterns associated with the different tissue sub-types with
better performance than standard approaches.
Keywords. mass spectrometry imaging, dimensionality reduction, variational autoencoder, desorption
electrospray ionization.
1 Introduction
In recent years, mass spectrometry imaging has acquired increasing importance among the metabolic ana-
lytical techniques, proving to be able to capture and represent in a concise way the complex heterogeneous
biochemical interactions. Because of its native high dimensionality (often of the order of 103 ? 104) and
the large number of samples (pixels), technical difficulties arise in the exploratory analysis of untargeted
datasets, such as cancer specimens, for which biochemical patterns are still unknown. In this context, data
dimensionality reduction can represent an opportune strategy with the aim of detecting and summarising
the underlying patterns that characterise the data structure.
Among the different available techniques, linear methods such as PCA or MDS, still widely used in the
field of mass spectrometry imaging, have shown to be limited in capturing complex non-linear molecular
patterns that can characterise the highly heterogeneous tissues [5]. For those reasons, we apply deep
generative VAE models to perform dimensionality reduction, data visualisation, and data compression,
proving that they perform better than standard methods, such as PCA. VAE deep structure models can
capture the distributions of the latent variables that determine the observed patterns and, at the same time,
provide a powerful tool to reconstruct the original data and to generate unseen data that has resemblance
of the original data.
Specifically, under the assumption that different tissue types are characterised by significantly distinct
mass spectra profile patterns (even if unmatched), we show that VAEs are capable of retrieving the latent
space representation in a reasonable amount of time with no need for either peak detection or spectral
alignment.
2 Variational autoencoders
Here we report a brief summary of the Variational Autoencoder (VAE) algorithm1.
1For a detailed description of the algorithm, we refer the reader to the original paper [3].
1
ar
X
iv
:1
70
8.
07
01
2v
2 
 [
q-
bi
o.
Q
M
] 
 2
4 
A
ug
 2
01
7
Figure 1: ”A scheme of a variational autoencoder. The encoder MLP transforms the input into the mean and the log-
variance of the prior p?(z). Using the reparameterization trick, z = µ + ?   is therefore passed to a decoder MLP which
finally generates the reconstructed data sample y.
VAE [3] represents an extension of Bayesian variational inference to large scale datasets where standard
approaches (such as MCMC sampling) are infeasible. The purpose of VAE is to learn an approximate
posterior inference model with continuous latent variables.
Let X =
{
x(i)
}
i=1,...,N
be a dataset of N i.i.d. samples of a continuous random variable x. The
assumption is that the data samples are generated by a random process, involving a ”latent” random
variable z. Specifically, z is sampled from a prior distribution p??(z), and x is sampled from the conditional
distribution p??(x|z). We must stress that the latent variable z and the parameter ?? are hidden from the
direct observation.
The estimation of the parameter ? and the posterior inference of the latent variable z is performed
by introducing a recognition model q?(z|x) which acts as an encoder that tries to approximate the true
posterior p?(z|x). Analogously, after sampling a z from the recognition model, a probabilistic decoder can
reconstruct the possible corresponding sample x.
On of the key aspects of the VAE algorithm is the ”reparameterisation trick”, by which we restrict
the recognition model to be differentiable. In this way, learning schemes such as gradient descent can
be applied. In our model, following the original method, z is sampled from a normal distribution with
diagonal variance and defined as z = µ+ ?, where µ and ? are the learnt mean and standard deviations,
respectively, and  ? N (0, I).
For the VAE applied in our work, the prior p?(z) = N (z; 0, I) and the posterior of the latent variable
q?(z|x) = N (z;µ, ?2I) were both assumed to be approximately a Gaussian with a diagonal covariance
(mean µ and variance ?2 are outputs of a multi-layer perceptron (MLP) applied to the data points x(i)),
and the posterior inference model p?(x|z) was assumed to be a multivariate Bernoulli distribution applied
to the z = µ+ ?, with  ? N (0, I). In this case, the cost function L is defined as the sum of the
Kullback-Leibler divergence from p?(z) to q?(z|x) and the negative reconstruction error2,
L(?, ?,x(i)) = 1
2
J?
j=1
(
1 + log
(
(?
(i)
j )
2
)
? (µ(i)j )2 ? (?
(i)
j )
2
)
+
1
L
L?
l=1
log p?(x
(i)|z(i,l)) (1)
where z(i,l) = µ(i) + ?(i)  (l) and  ? N (0, I).
For Bernoulli outputs, the second term corresponds to the cross-entropy
log p(x|z) =
M?
i=1
xi log yi + (1? xi) log(1? yi) (2)
where y is the output of an MLP. A schematic representation of the network architecture is shown in Fig.
1.
2J is the latent space dimensionality.
2
3 Experiments
Desorption electrospray ionisation mass spectrometry (DESI) imaging data from 6 human colon tissue
specimens (first column of Fig. 3) was used to evaluate the capabilities of VAE models to perform data
compression (dimensionality reduction + data reconstruction), compared to a standard PCA. All the
mass spectrometry data were acquired using a Waters XEVO-G2XS Q-TOF mass spectrometer, set in the
negative ion mode.
All the spectral profiles were linearly interpolated with a uniform sampling step of 0.02 m/z in the
range of 600-1,000 m/z, resulting in a dimensionality of 20,001. The only preprocessing steps necessary
for our analysis consisted of: 1) application of the log(x + 1) intensity transformation to reduce data
heteroscedasticity; 2) intensities transformation by the logistic function on the median centred spectrum
intensities
x?
(i)
=
1
1 + exp(?(x(i) ?m(i)))
. (3)
where m(i) is the (non-zero) median of the spectrum intensities. Those transformations allowed mapping
of the spectral intensities onto a range of [0-1], in such a way they could be interpret as probabilities to
find a source of signal at the corresponding m/z value, and, at the same time and to compress the large
variabilities of high/low intense signals across the different pixels.
The purpose of these experiments is to compare the capability of VAE and PCA to reduce the data
dimensionality while preserving the spatial structures in the tissues associated with a molecular hetero-
geneity, through their latent space representations of the mass spectrometry data.
The used VAE model constructed consisted of 20,001 input neurons, an encoder MLP with 5 hidden
layers (5,000, 2000, 500, 50, 10, neurons respectively), a latent dimension of 3 and a decoder MLP with
the mirrored topology of the encoder MLP. In each MLP, exponential linear unit (ELU) activations were
employed. The network was trained with mini-batches of 256 spectra using the Adam algorithm [2] with
a learning rate of 0.0001 for 30 epochs (Fig. 4). The loss function converged after few iterations (usually
less than 200) as shown in Fig. 5. The VAE model was trained using a leave-one-sample-out procedure.
The spectra of 5 tissue samples were used as a training set (corresponding to ?40,000 spectra), and
the model was evaluated on the spectra of the held-out tissue sample. In each round of the evaluation
procedure, after training the model, the 3-dimensional latent variables associated to each pixel of the test
sample were plotted as (normalised) intensities of the RGB channels. In this way, it could be seen that it
was straightforward to visualise how the 3 latent components were mixing across the different regions of
the tissue, while expecting that similar tissue types (characterised by similar spectral profiles) would be
assigned to similar colours. As a comparison, the same graphical procedure was used to plot the scores of
the first 3 principal components calculated by projecting the test spectra on the loadings obtained from
the training set.
All the VAE models were trained and tested on an NVIDIA GTX 1080 Ti using Tensorflow [1] resulting
in a computational time of about 6 minutes, whereas PCA was calculated through Scikit-learn package for
Python [4].
Most of the mass spectrometry signal was uninformative, as shown by the fact that the first 3 principal
components explained 10% of the total variance. Additionally, it was observed that when applying the
total-ion-count normalisation followed by the log-transformation, the first 3 principal components could
explain up to 80% of the total variance, but the images corresponding to those scores were noisy and the
tissue structures were barely distinguishable (Fig. 2). For this reason, the same preprocessing described
before for both VAE and PCA was used.
As reported in Fig. 6, VAEs were capable of differentiating more clusters than PCA which corresponds
to distinguishing between a larger number of different substructures (e.g. in the centre of the tissue of the
first sample in Fig. 3). This result was confirmed by applying a clustering on the latent representation
of the test samples using Gaussian Mixture models (GMM) (full covariance, num. repetitions = 5, max.
3
Sample PCA VAE
sample1 0.06804 0.02736
sample2 0.06856 0.02802
sample3 0.06782 0.02707
sample4 0.06677 0.02735
sample5 0.08209 0.04176
sample6 0.06525 0.02771
Table 1: Mean squared error between the input and the reconstructed spectral data using PCA and VAE confirms that
VAE models can compress and reconstruct the original data more faithfully.
iterations = 1000). Indeed, it was observed that the VAE model could provide clusters that more accurately
resembled the tissue morphology than those identified using the corresponding PCA latent representation
(Fig. 3). An example of the clusters generated by GMM with a varying number of components (2 to 19)
using the PCA scores and VAE latent variables is shown in Fig. 7 and Fig. 8.
Subsequently, since PCA and VAE can be used as methods to compress the data, both providing a
way to reconstruct the original data from their latent (low-dimensional) representation, the accuracy of
the reconstructed data evaluated compared to the original input. PCA reconstruction was performed by
multiplying the 3-dimensional scores by the corresponding 3 principal loadings of the training set, whereas
VAE reconstruction was performed by passing the test sample latent variables through the decoder MLP of
the model fitted on the training set. The mean squared error (MSE) (Table 1), calculated between the input
and reconstructed data, confirmed that the VAE models were capable of compressing and reconstructing
the data more faithfully.
4 Conclusions and future work
Mass spectrometry imaging data represent an invaluable resource of information about the biochemical
interactions characterising living organisms. Because of their native high dimensionality, data visualisation
and compression are of critical importance in order to understand the underlying patterns representing
possible metabolic pathways. Compared to standard methods, such as PCA, deep Variational Autoen-
coders represent a powerful tool for the unsupervised data exploration of such data, being able to capture
the latent variables distribution. Using Variational autoencoders on DESI imaging data, we have shown
that this method can compress the data better than PCA, and provide more precise clustering results.
In future we will test the performances of VAE models for the dimensionality reduction of MSI dataset
from heterogeneous tissue types and acquired with different platform, in order to evaluate the limit of
applicability of this technique.
5 Acknowledgements
Human tissue samples were obtained with informed consent under local ethical approval (14/EE/0024).
References
[1] Mart??n Abadi, Ashish Agarwal, Paul Barham, Eugene Brevdo, Zhifeng Chen, Craig Citro, Greg S.
Corrado, Andy Davis, Jeffrey Dean, Matthieu Devin, Sanjay Ghemawat, Ian Goodfellow, Andrew Harp,
Geoffrey Irving, Michael Isard, Yangqing Jia, Rafal Jozefowicz, Lukasz Kaiser, Manjunath Kudlur,
Josh Levenberg, Dan Mane?, Rajat Monga, Sherry Moore, Derek Murray, Chris Olah, Mike Schuster,
Jonathon Shlens, Benoit Steiner, Ilya Sutskever, Kunal Talwar, Paul Tucker, Vincent Vanhoucke, Vijay
4
Figure 2: Visualisation of the first 3 principal components normalised scores of the TIC normalised data, as RGB intensities.
Despite the first 3 principal components explained ? 80% of the total variance, the captured variation consisted mainly of
noise, as visible outside of the tissue region.
Vasudevan, Fernanda Vie?gas, Oriol Vinyals, Pete Warden, Martin Wattenberg, Martin Wicke, Yuan
Yu, and Xiaoqiang Zheng. TensorFlow: Large-scale machine learning on heterogeneous systems, 2015.
Software available from tensorflow.org.
[2] D. P. Kingma and J. Ba. Adam: A Method for Stochastic Optimization. ArXiv e-prints, December
2014.
[3] D. P Kingma and M. Welling. Auto-Encoding Variational Bayes. ArXiv e-prints, December 2013.
[4] F. Pedregosa, G. Varoquaux, A. Gramfort, V. Michel, B. Thirion, O. Grisel, M. Blondel, P. Pret-
tenhofer, R. Weiss, V. Dubourg, J. Vanderplas, A. Passos, D. Cournapeau, M. Brucher, M. Perrot,
and E. Duchesnay. Scikit-learn: Machine learning in Python. Journal of Machine Learning Research,
12:2825–2830, 2011.
[5] Spencer A Thomas, Alan M Race, Rory T Steven, Ian S Gilmore, and Josephine Bunch. Dimension-
ality reduction of mass spectrometry imaging data using autoencoders. In Computational Intelligence
(SSCI), 2016 IEEE Symposium Series on, pages 1–7. IEEE, 2016.
5
Figure 3: In each row, the results of one of the tested samples are reported. From left to right: H&E stained tissue samples,
RGB visualisation of the normalised scores of the 3 first principal components, GMM clustering using the PCA scores, RGB
visualisation of the normalised 3 latent variables of the VAE model, GMM clustering using the VAE latent variables. The
selected number of clusters corresponded to the closest partition to the optical image (in a range of 2 to 19).
6
Figure 4: Schematic representation of the VAE model used in our experiments. The image was generated using Tensorboard.
Figure 5: Loss curve for the training of the VAE model. After few iterations (less than 200) the loss fluctuates around its
minimum value.
7
Figure 6: Left: Scatter plot of the VAE 3-dimensional latent space for the second sample (second row of Fig 3) shows
the capability of VAE of distinguishing some of the clusters (e.g. the yellow cluster). The point colours correspond to their
normalised components (RGB). Center: Scatter plot of the first 3 principal components scores (In each axis, the explained
variance is reported). Right: Here the colours of the PCA scores are the same used for the VAE scatter plot, in order to
compare the position of same points.
Figure 7: Example of the GMM clustering with a number of clusters varying in a range of 2 to 19 applied to the first
3 principal components shows that some of the main tissue structures (e.g. the sub-type in the centre, Fig. 3) were not
detected.
8
Figure 8: Example of the GMM clustering with a number of clusters varying in a range of 2 to 19 applied to the VAE
latent variables shows that in almost all the partitions, the main tissue structures (e.g. the sub-type in the centre, Fig. 3)
were identified as different sub-types.
9
